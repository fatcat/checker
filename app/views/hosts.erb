<div class="hosts-page">
  <div class="page-header">
    <h1>Hosts</h1>
    <button class="btn btn-primary" onclick="Hosts.showAddForm()">Add Host</button>
  </div>

  <div id="host-form-container" class="form-container" style="display: none;">
    <form id="host-form" class="host-form">
      <input type="hidden" id="host-id" value="">

      <div class="form-group">
        <label for="host-name">Name</label>
        <input type="text" id="host-name" placeholder="e.g., Google DNS" required>
      </div>

      <div class="form-group">
        <label for="host-address">Address</label>
        <input type="text" id="host-address" placeholder="e.g., 8.8.8.8 or google.com" required>
      </div>

      <div class="form-group">
        <label for="host-randomness">
          Test Timing Variability (%)
          <span class="tooltip-icon" title="Adds timing variation to prevent all tests running simultaneously. Example: 5% on a 5-minute interval = ±15 seconds randomness.">?</span>
        </label>
        <input type="number" id="host-randomness" value="5" min="0" max="50" step="1">
        <small class="form-hint">Recommended: 5%. Prevents thundering herd when scheduling tests.</small>
      </div>

      <!-- Test Configuration Section -->
      <div class="form-section">
        <h3>Test Configuration</h3>
        <p class="form-hint">Ping test is always enabled for jitter measurement. Select additional tests below.</p>

        <!-- Ping Test (Always Enabled) -->
        <div class="test-config-row test-config-ping">
          <div class="test-checkbox">
            <input type="checkbox" id="test-ping" checked>
            <label for="test-ping">Ping (ICMP)</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="ping-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
          <div class="test-fields"></div>
        </div>

        <!-- TCP Test -->
        <div class="test-config-row test-config-tcp">
          <div class="test-checkbox">
            <input type="checkbox" id="test-tcp" onchange="Hosts.toggleTestFields('tcp')">
            <label for="test-tcp">TCP Port</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="tcp-enabled" checked disabled>
            <span class="toggle-slider"></span>
          </label>
          <div class="test-fields" id="tcp-fields" style="display: none;">
            <div class="field-group">
              <label for="tcp-port">Port</label>
              <input type="number" id="tcp-port" placeholder="e.g., 22, 80, 443" min="1" max="65535">
            </div>
          </div>
        </div>

        <!-- HTTP Test -->
        <div class="test-config-row test-config-http">
          <div class="test-checkbox">
            <input type="checkbox" id="test-http" onchange="Hosts.toggleTestFields('http')">
            <label for="test-http">HTTP</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="http-enabled" checked disabled>
            <span class="toggle-slider"></span>
          </label>
          <div class="test-fields" id="http-fields" style="display: none;">
            <div class="field-group">
              <label>Scheme & Port</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="http-scheme" value="http" checked>
                  HTTP (80)
                </label>
                <label>
                  <input type="radio" name="http-scheme" value="https">
                  HTTPS (443)
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- DNS Test -->
        <div class="test-config-row test-config-dns">
          <div class="test-checkbox">
            <input type="checkbox" id="test-dns" onchange="Hosts.toggleTestFields('dns')">
            <label for="test-dns">DNS Resolution</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="dns-enabled" checked disabled>
            <span class="toggle-slider"></span>
          </label>
          <div class="test-fields" id="dns-fields" style="display: none;">
            <div class="field-group">
              <label for="dns-hostname">Hostname to Resolve</label>
              <input type="text" id="dns-hostname" placeholder="e.g., google.com">
              <small class="form-hint">Hostname this DNS server should resolve</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Validation Results Area (shown after save) -->
      <div id="validation-results" class="validation-results" style="display: none;">
        <h4>Test Validation Results</h4>
        <div id="validation-list"></div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-success-muted" id="save-btn">Save & Test</button>
        <button type="button" class="btn btn-secondary" onclick="Hosts.hideForm()">Cancel</button>
        <button type="button" class="btn btn-success" id="continue-btn" style="display: none;" onclick="Hosts.hideForm()">Continue</button>
      </div>

      <div id="form-status" class="form-status"></div>
    </form>
  </div>

  <table class="table" id="hosts-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Address</th>
        <th>Tests</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="hosts-tbody">
      <tr>
        <td colspan="5" class="loading">Loading hosts...</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
const Hosts = {
  formChanged: false,

  init() {
    this.loadHosts();
    document.getElementById('host-form').addEventListener('submit', (e) => this.saveHost(e));

    // Ensure ping checkbox always stays checked
    document.getElementById('test-ping').addEventListener('change', function(e) {
      if (!this.checked) {
        this.checked = true;
      }
    });

    // Track form changes
    this.initFormChangeTracking();
  },

  initFormChangeTracking() {
    const form = document.getElementById('host-form');
    const saveBtn = document.getElementById('save-btn');

    // Track changes on all form inputs
    form.addEventListener('input', () => {
      this.formChanged = true;
      saveBtn.classList.remove('btn-success-muted');
      saveBtn.classList.add('btn-success-bright');
    });

    // Track changes on checkboxes
    form.addEventListener('change', () => {
      this.formChanged = true;
      saveBtn.classList.remove('btn-success-muted');
      saveBtn.classList.add('btn-success-bright');
    });
  },

  resetSaveButton() {
    const saveBtn = document.getElementById('save-btn');
    saveBtn.classList.remove('btn-success-bright');
    saveBtn.classList.add('btn-success-muted');
    this.formChanged = false;
  },

  async loadHosts() {
    const tbody = document.getElementById('hosts-tbody');
    try {
      const response = await fetch('/api/hosts');
      const data = await response.json();

      if (data.hosts && data.hosts.length > 0) {
        tbody.innerHTML = data.hosts.map(host => this.renderHostRow(host)).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="loading">No hosts configured.</td></tr>';
      }
    } catch (error) {
      console.error('Failed to load hosts:', error);
      tbody.innerHTML = '<tr><td colspan="5" class="loading">Failed to load hosts.</td></tr>';
    }
  },

  renderHostRow(host) {
    const statusBadge = host.enabled
      ? '<span class="status-badge up">Enabled</span>'
      : '<span class="status-badge down">Disabled</span>';

    // Render test badges with color coding
    const testBadges = host.tests.map(test => {
      const colorClass = this.getStatusColorClass(test.status);
      const enabledText = test.enabled ? '' : ' (disabled)';
      let testLabel = test.test_type.toUpperCase();

      // Add extra info for specific tests
      if (test.test_type === 'tcp' && test.port) {
        testLabel += `:${test.port}`;
      } else if (test.test_type === 'http') {
        testLabel += ` ${test.http_scheme || 'http'}:${test.port || 80}`;
      } else if (test.test_type === 'dns') {
        testLabel += ` (${test.dns_query_hostname || '?'})`;
      }

      return `<span class="test-badge test-badge-${colorClass}">${testLabel}${enabledText}</span>`;
    }).join(' ');

    return `
      <tr data-id="${host.id}">
        <td>${this.escapeHtml(host.name)}</td>
        <td>${this.escapeHtml(host.address)}</td>
        <td>${testBadges}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-secondary" onclick="Hosts.editHost(${host.id})">Edit</button>
          <button class="btn btn-danger" onclick="Hosts.deleteHost(${host.id})">Delete</button>
        </td>
      </tr>
    `;
  },

  getStatusColorClass(status) {
    switch(status) {
      case 'success': return 'green';
      case 'degraded': return 'yellow';
      case 'failure': return 'red';
      case 'never': return 'gray';
      default: return 'gray';
    }
  },

  showAddForm() {
    document.getElementById('host-id').value = '';
    document.getElementById('host-form').reset();
    document.getElementById('host-randomness').value = '5'; // Default to 5%
    document.getElementById('validation-results').style.display = 'none';
    document.getElementById('continue-btn').style.display = 'none';
    document.getElementById('save-btn').disabled = false;
    this.resetSaveButton();

    // Reset all test checkboxes and fields
    ['tcp', 'http', 'dns'].forEach(type => {
      document.getElementById(`test-${type}`).checked = false;
      this.toggleTestFields(type);
    });

    document.getElementById('host-form-container').style.display = 'block';
  },

  hideForm() {
    document.getElementById('host-form-container').style.display = 'none';
    this.loadHosts(); // Refresh the table
  },

  toggleTestFields(testType) {
    const checkbox = document.getElementById(`test-${testType}`);
    const fields = document.getElementById(`${testType}-fields`);
    const enabledToggle = document.getElementById(`${testType}-enabled`);

    if (checkbox.checked) {
      fields.style.display = 'flex';
      enabledToggle.disabled = false;
      // Set required attribute on inputs when enabled
      if (testType === 'tcp') {
        document.getElementById('tcp-port').required = true;
      } else if (testType === 'dns') {
        document.getElementById('dns-hostname').required = true;
      }
    } else {
      fields.style.display = 'none';
      enabledToggle.disabled = true;
      // Remove required attribute
      if (testType === 'tcp') {
        document.getElementById('tcp-port').required = false;
      } else if (testType === 'dns') {
        document.getElementById('dns-hostname').required = false;
      }
    }
  },

  async editHost(id) {
    try {
      const response = await fetch(`/api/hosts/${id}`);
      const host = await response.json();

      document.getElementById('host-id').value = host.id;
      document.getElementById('host-name').value = host.name;
      document.getElementById('host-address').value = host.address;
      document.getElementById('host-randomness').value = host.randomness_percent || 5;
      document.getElementById('validation-results').style.display = 'none';
      document.getElementById('continue-btn').style.display = 'none';
      document.getElementById('save-btn').disabled = false;
      this.resetSaveButton();

      // Reset all test checkboxes first
      ['tcp', 'http', 'dns'].forEach(type => {
        document.getElementById(`test-${type}`).checked = false;
        this.toggleTestFields(type);
      });

      // Load tests
      host.tests.forEach(test => {
        if (test.test_type === 'ping') {
          document.getElementById('ping-enabled').checked = test.enabled;
        } else if (test.test_type === 'tcp') {
          document.getElementById('test-tcp').checked = true;
          document.getElementById('tcp-port').value = test.port || '';
          document.getElementById('tcp-enabled').checked = test.enabled;
          this.toggleTestFields('tcp');
        } else if (test.test_type === 'http') {
          document.getElementById('test-http').checked = true;
          const scheme = test.http_scheme || 'https';
          document.querySelector(`input[name="http-scheme"][value="${scheme}"]`).checked = true;
          document.getElementById('http-enabled').checked = test.enabled;
          this.toggleTestFields('http');
        } else if (test.test_type === 'dns') {
          document.getElementById('test-dns').checked = true;
          document.getElementById('dns-hostname').value = test.dns_query_hostname || '';
          document.getElementById('dns-enabled').checked = test.enabled;
          this.toggleTestFields('dns');
        }
      });

      document.getElementById('host-form-container').style.display = 'block';
    } catch (error) {
      console.error('Failed to load host:', error);
      alert('Failed to load host data');
    }
  },

  async saveHost(e) {
    e.preventDefault();

    const id = document.getElementById('host-id').value;
    const tests = [];

    // Always include ping test
    tests.push({
      test_type: 'ping',
      enabled: document.getElementById('ping-enabled').checked
    });

    // Add TCP test if checked
    if (document.getElementById('test-tcp').checked) {
      tests.push({
        test_type: 'tcp',
        port: parseInt(document.getElementById('tcp-port').value),
        enabled: document.getElementById('tcp-enabled').checked
      });
    }

    // Add HTTP test if checked
    if (document.getElementById('test-http').checked) {
      const scheme = document.querySelector('input[name="http-scheme"]:checked').value;
      const port = scheme === 'https' ? 443 : 80;
      tests.push({
        test_type: 'http',
        http_scheme: scheme,
        port: port,
        enabled: document.getElementById('http-enabled').checked
      });
    }

    // Add DNS test if checked
    if (document.getElementById('test-dns').checked) {
      tests.push({
        test_type: 'dns',
        dns_query_hostname: document.getElementById('dns-hostname').value,
        enabled: document.getElementById('dns-enabled').checked
      });
    }

    const data = {
      name: document.getElementById('host-name').value,
      address: document.getElementById('host-address').value,
      randomness_percent: parseInt(document.getElementById('host-randomness').value) || 5,
      enabled: true,
      tests: tests,
      validate_immediately: true
    };

    try {
      // Disable save button and show loading
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Testing...';
      this.showStatus('Running validation tests...', 'info');

      const url = id ? `/api/hosts/${id}` : '/api/hosts';
      const method = id ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const result = await response.json();

        // Revert button to normal state
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save & Test';
        this.resetSaveButton();

        // Display validation results if present
        if (result.validation_results) {
          this.displayValidationResults(result.validation_results);
          this.showStatus('Validation complete!', 'success');

          // Show continue button
          document.getElementById('continue-btn').style.display = 'inline-block';
        } else {
          this.showStatus('Host saved successfully!', 'success');
          setTimeout(() => this.hideForm(), 1500);
        }
      } else {
        const error = await response.json();
        this.showStatus('Failed to save host: ' + (error.error || 'Unknown error'), 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save & Test';
        this.resetSaveButton();
      }
    } catch (error) {
      console.error('Failed to save host:', error);
      this.showStatus('Failed to save host: ' + error.message, 'error');
      document.getElementById('save-btn').disabled = false;
      document.getElementById('save-btn').textContent = 'Save & Test';
    }
  },

  displayValidationResults(results) {
    const container = document.getElementById('validation-results');
    const list = document.getElementById('validation-list');

    list.innerHTML = results.map(r => {
      const statusClass = r.result.reachable ? 'success' : 'failure';
      const statusIcon = r.result.reachable ? '✓' : '✗';
      const latency = r.result.latency_ms ? `${r.result.latency_ms.toFixed(2)}ms` : 'N/A';
      const errorMsg = r.result.error ? `<div class="error-detail">${this.escapeHtml(r.result.error)}</div>` : '';

      return `
        <div class="validation-item validation-${statusClass}">
          <span class="validation-icon">${statusIcon}</span>
          <span class="validation-type">${r.test_type.toUpperCase()}</span>
          <span class="validation-status">${r.result.reachable ? 'Success' : 'Failed'}</span>
          <span class="validation-latency">${latency}</span>
          ${errorMsg}
        </div>
      `;
    }).join('');

    container.style.display = 'block';
  },

  showStatus(message, type) {
    const status = document.getElementById('form-status');
    status.textContent = message;
    status.className = `form-status form-status-${type}`;
    status.style.display = 'block';
  },

  async deleteHost(id) {
    if (!confirm('Are you sure you want to delete this host? This will delete all associated tests and measurements.')) return;

    try {
      const response = await fetch(`/api/hosts/${id}`, { method: 'DELETE' });
      if (response.ok) {
        this.loadHosts();
      } else {
        alert('Failed to delete host');
      }
    } catch (error) {
      console.error('Failed to delete host:', error);
      alert('Failed to delete host');
    }
  },

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

document.addEventListener('DOMContentLoaded', () => Hosts.init());
</script>
